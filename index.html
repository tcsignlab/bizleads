<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LeadSource USA ‚Äî National New Business Intelligence Map</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c10;
    --panel: #111318;
    --border: #1e2330;
    --accent: #667eea;
    --glow: rgba(102,126,234,0.4);
    --text: #f0f4ff;
    --muted: #6b7280;
    --heat-0:   #1a1f2e;
    --heat-active: #014721;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html, body { height:100%; overflow-x:hidden; }
  body {
    background: var(--bg);
    font-family: 'Inter', sans-serif;
    color: var(--text);
    min-height: 100vh;

  }

  /* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 18px 32px;
    border-bottom: 1px solid var(--border);
    background: rgba(10,12,16,0.96);
    position: sticky; top: 0; z-index: 100;
    backdrop-filter: blur(16px);
  }
  .logo { display: flex; align-items: center; gap: 14px; }
  .logo-icon {
    width:44px; height:44px; background:transparent; border-radius:8px;
    display:flex; align-items:center; justify-content:center; font-size:20px;
    box-shadow:0 0 24px var(--glow);
  }
  .logo-text { font-family:'Bebas Neue',sans-serif; font-size:1.8rem; letter-spacing:2px; line-height:1; }
  .logo-sub { font-size:0.7rem; color:var(--muted); letter-spacing:3px; text-transform:uppercase; }
  .header-stats { display:flex; gap:32px; }
  .hstat { text-align:center; }
  .hstat-val { font-family:'Bebas Neue',sans-serif; font-size:2rem; line-height:1; color:var(--accent); }
  .hstat-label { font-size:0.65rem; color:var(--muted); text-transform:uppercase; letter-spacing:2px; }
  .header-right { display:flex; align-items:center; gap:16px; }
  .live-badge {
    display:flex; align-items:center; gap:8px;
    background:rgba(16,185,129,0.1); border:1px solid rgba(16,185,129,0.3);
    padding:8px 16px; border-radius:24px; font-size:0.75rem;
    color:#10b981; font-weight:700; letter-spacing:1px;
  }
  .live-dot { width:8px; height:8px; background:#10b981; border-radius:50%; animation:pulse-green 2s infinite; }
  @keyframes pulse-green { 0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,0.6)} 50%{box-shadow:0 0 0 6px rgba(16,185,129,0)} }
  .btn-status {
    padding: 10px 20px;
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #e8eaf6;
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.3s;
  }
  .btn-status:hover {
    background: rgba(102, 126, 234, 0.2);
    border-color: #667eea;
  }

  /* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
  .main { display:grid; grid-template-columns:1fr 200px; min-height:calc(100vh - 73px); }
  .side-panel { background:var(--panel); border-right:1px solid var(--border); padding:24px 16px; overflow-y:auto; }
  .side-panel.right { border-right:none; border-left:1px solid var(--border); }
  .panel-title {
    font-family:'Bebas Neue',sans-serif; font-size:0.95rem; letter-spacing:3px;
    color:var(--muted); margin-bottom:16px; padding-bottom:8px; border-bottom:1px solid var(--border);
  }

  /* Legend */
  .legend-item { display:flex; align-items:center; gap:12px; margin:10px 0; font-size:0.82rem; }
  .legend-dot { width:14px; height:14px; border-radius:3px; flex-shrink:0; }
  .legend-label { color:#c0c8d8; }
  .legend-count { margin-left:auto; color:var(--muted); font-size:0.75rem; }

  /* Top States */
  .top-state-item {
    display:flex; align-items:center; gap:10px; padding:8px 10px;
    border-radius:8px; margin:4px 0; cursor:pointer; transition:background 0.2s; font-size:0.82rem;
  }
  .top-state-item:hover { background:rgba(255,255,255,0.05); }
  .top-state-rank { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--muted); width:20px; }
  .top-state-name { flex:1; font-weight:600; }
  .top-state-leads {
    background:rgba(102,126,234,0.15); color:var(--accent);
    padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:700;
  }

  /* Activity */
  .activity-item { display:flex; gap:8px; padding:8px 0; border-bottom:1px solid var(--border); font-size:0.78rem; }
  .activity-dot { width:8px; height:8px; border-radius:50%; margin-top:4px; flex-shrink:0; }
  .activity-text { color:#a0aec0; line-height:1.4; }
  .activity-time { color:var(--muted); font-size:0.7rem; margin-top:2px; }

  /* ‚îÄ‚îÄ‚îÄ MAP AREA ‚îÄ‚îÄ‚îÄ */
  .map-area { padding:28px 32px; display:flex; flex-direction:column; align-items:center; }
  .map-title-row { text-align:center; margin-bottom:20px; }
  .map-title-row h2 { font-family:'Bebas Neue',sans-serif; font-size:2.4rem; letter-spacing:4px; line-height:1; }
  .map-title-row p { color:var(--muted); font-size:0.8rem; letter-spacing:2px; text-transform:uppercase; margin-top:4px; }
  #map-container { width:100%; max-width:880px; }

  /* ‚îÄ‚îÄ‚îÄ D3 MAP STYLES ‚îÄ‚îÄ‚îÄ */
  .state-path {
    stroke: #0d1017;
    stroke-width: 0.8px;
    cursor: pointer;
    transition: fill 0.3s ease, filter 0.2s ease;
  }
  .state-path:hover {
    filter: brightness(1.6) drop-shadow(0 0 6px rgba(102,126,234,0.5));
    stroke: rgba(255,255,255,0.5);
    stroke-width: 1.5px;
  }
  .tier-0      { fill: var(--heat-0); }
  .tier-active { fill: var(--heat-active); }

  .state-label {
    font-family:'Inter',sans-serif; font-weight:700;
    fill:rgba(255,255,255,0.6); pointer-events:none; font-size:7px;
  }

  /* ‚îÄ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ‚îÄ */
  #tooltip {
    position:fixed; background:rgba(10,12,16,0.97); border:1px solid var(--border);
    border-radius:12px; padding:18px 22px; pointer-events:none; opacity:0;
    transition:opacity 0.15s; z-index:1000; min-width:210px;
    backdrop-filter:blur(20px);
    box-shadow:0 20px 60px rgba(0,0,0,0.7), 0 0 0 1px rgba(255,255,255,0.05);
  }
  #tooltip.visible { opacity:1; }
  .tt-state { font-family:'Bebas Neue',sans-serif; font-size:1.4rem; letter-spacing:2px; margin-bottom:8px; }
  .tt-leads { font-size:2rem; font-weight:900; color:var(--accent); line-height:1; }
  .tt-sub { font-size:0.75rem; color:var(--muted); margin-top:2px; }
  .tt-hot-warm { font-size:0.78rem; color:#a0aec0; margin-top:6px; }
  .tt-status { margin-top:10px; font-size:0.75rem; font-weight:700; letter-spacing:1px; text-transform:uppercase; }
  .tt-status.active { color:#10b981; }
  .tt-status.coming { color:var(--muted); }
  .tt-click { font-size:0.7rem; color:#4a90e2; margin-top:6px; }

  /* Sync bar */
  .sync-bar {
    width:100%; max-width:880px; display:flex; align-items:center; justify-content:space-between;
    margin-top:12px; padding:8px 16px;
    background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px;
    font-size:0.75rem; color:var(--muted);
  }
  .sync-bar span { display:flex; align-items:center; gap:6px; }

  /* Loading state */
  .loading-map {
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    padding:80px 20px; text-align:center; color:var(--muted);
  }
  .loading-map .spinner {
    width:40px; height:40px; margin-bottom:20px;
    border:3px solid rgba(102,126,234,0.2); border-top-color:var(--accent);
    border-radius:50%; animation:spin 1s linear infinite;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  /* Ads Panel */
  .ads-panel { background:var(--panel); border-left:1px solid var(--border); padding:24px 14px; overflow-y:auto; }
  .ad-slot {
    background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1);
    border-radius: 8px; padding: 16px 10px; text-align: center; margin-bottom: 14px;
    color: var(--muted); font-size: 0.72rem; letter-spacing: 1px;
  }
  .ad-slot .ad-label { font-family:'Bebas Neue',sans-serif; font-size:0.8rem; letter-spacing:2px; color:rgba(255,255,255,0.15); margin-bottom:8px; }
  .ad-slot .ad-placeholder { font-size:0.7rem; color:rgba(255,255,255,0.12); }

  /* Top States Below Map */
  .top-states-below {
    width:100%; max-width:880px; margin-top:20px;
    background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:16px 24px;
  }
  .top-states-below .panel-title { margin-bottom:12px; }
  .top-states-grid {
    display:flex; flex-direction:row; align-items:stretch;
  }
  .top-state-item {
    display:flex; align-items:center; gap:8px; padding:8px 16px;
    cursor:pointer; transition:background 0.2s; font-size:0.82rem;
    flex:1; border-radius:8px;
  }
  .top-state-item:hover { background:rgba(255,255,255,0.05); }
  .top-state-divider {
    width:1px; background:var(--border); align-self:stretch; flex-shrink:0;
  }
  .top-state-rank { font-family:'Bebas Neue',sans-serif; font-size:1rem; color:var(--muted); width:18px; }
  .top-state-name { flex:1; font-weight:600; white-space:nowrap; }
  .top-state-leads {
    background:rgba(102,126,234,0.15); color:var(--accent);
    padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:700;
  }

  @media (max-width: 1024px) {
    .main { grid-template-columns: 1fr; }
    .side-panel { border:none; border-bottom:1px solid var(--border); }
    .ads-panel {
      border-top:1px solid var(--border); border-left:none;
      display:flex; flex-direction:row; flex-wrap:wrap;
      gap:12px; padding:16px; align-items:flex-start; justify-content:center;
    }
    .ads-panel .panel-title { width:100%; }
    .ad-slot { margin-bottom:0 !important; }
    .top-states-grid { flex-wrap:wrap; }
    .top-state-divider { display:none; }
    .header-stats { gap:20px; }
    .hstat-val { font-size:1.6rem; }
  }
  @media (max-width: 640px) {
    header { flex-direction:column; gap:16px; }
    .header-stats { width:100%; justify-content:space-around; }
    .ads-panel { justify-content:center; }
    .top-states-grid { flex-direction:column; }
    .top-state-divider { display:none; }
    .map-area { padding:16px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">üí≤</div>
    <div>
      <div class="logo-text">LeadSource USA ‚Äî National Intelligence Map</div>
      <div class="logo-sub">New Business Intelligence</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="hstat">
      <div class="hstat-val" id="stat-total-leads">‚Äî</div>
      <div class="hstat-label">Total New Businesses</div>
    </div>
    <div class="hstat">
      <div class="hstat-val" id="stat-active-states">‚Äî</div>
      <div class="hstat-label">Active States</div>
    </div>
    <div class="hstat">
      <div class="hstat-val" id="stat-new-today">‚Äî</div>
      <div class="hstat-label">New Leads Today</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-badge">
      <div class="live-dot"></div>
      <span>LIVE DATA (UPDATED DAILY)</span>
    </div>
    <a href="status.html" class="btn-status" style="display:none;">üìä Status</a>
  </div>
</header>

<div class="main">

  <!-- CENTER: MAP -->
  <div class="map-area">
    <div class="map-title-row">
      <h2>NEW BUSINESS LEADS</h2>
      <p>Click any state to view detailed business listings</p>
    </div>
    <div id="map-container">
      <div class="loading-map">
        <div class="spinner"></div>
        <p>Loading map...</p>
      </div>
      <svg id="usmap" style="display:none;"></svg>
    </div>
    <div class="sync-bar">
      <span>Last updated: <strong id="last-update">‚Äî</strong></span>
      <span>Data Source: Government New Business Registries</span>
    </div>

    <!-- TOP STATES BELOW MAP -->
    <div class="top-states-below">
      <div class="panel-title">üèÜ TOP STATES</div>
      <div style="text-align:left; font-size:0.75rem; color:var(--muted); margin-bottom:12px;" id="top-states-total">‚Äî</div>
      <div class="top-states-grid" id="top-states-list"></div>
    </div>
  </div>

  <!-- RIGHT PANEL: ADS -->
  <div class="ads-panel">
    <div class="panel-title">üì¢ SPONSORED</div>
    <div class="ad-slot" style="margin-bottom:14px;">
      <div class="ad-label">Advertisement</div>
      <div style="height:120px; display:flex; align-items:center; justify-content:center;">
        <div class="ad-placeholder">160 √ó 120<br>Ad Space</div>
      </div>
    </div>
    <style>
      @keyframes bgMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
      @keyframes floatUp { from{bottom:-10px;transform:scale(0.6)} to{bottom:210px;transform:scale(1.2)} }
      @keyframes adPop { 0%,100%{transform:scale(1)} 50%{transform:scale(1.08)} }
      @keyframes adPulse2 { 0%{transform:scale(1)} 50%{transform:scale(1.12)} 100%{transform:scale(1)} }
    </style>
    <div class="ad-slot" style="padding:0;border:none;background:none;margin-bottom:14px;">
      <a href="https://tcsignlab.github.io/bizleads/index.html" target="_blank" style="text-decoration:none;">
        <div style="width:160px;height:200px;position:relative;overflow:hidden;font-family:Arial,Helvetica,sans-serif;background:linear-gradient(270deg,#7f00ff,#00c6ff,#00ff99);background-size:600% 600%;animation:bgMove 6s ease infinite;border-radius:10px;box-shadow:0 0 18px rgba(0,255,200,0.6);">
          <div style="position:absolute;left:20px;width:6px;height:6px;background:#fff;border-radius:50%;opacity:0.7;animation:floatUp 4s linear infinite;animation-delay:0s;"></div>
          <div style="position:absolute;left:80px;width:6px;height:6px;background:#fff;border-radius:50%;opacity:0.7;animation:floatUp 4s linear infinite;animation-delay:1s;"></div>
          <div style="position:absolute;left:130px;width:6px;height:6px;background:#fff;border-radius:50%;opacity:0.7;animation:floatUp 4s linear infinite;animation-delay:2s;"></div>
          <div style="position:relative;z-index:2;padding:10px;text-align:center;color:#fff;">
            <div style="font-size:15px;font-weight:bold;line-height:1.1;text-shadow:0 0 8px #000;animation:adPop 1.5s infinite;">NEED<br>MORE<br>LEADS?</div>
            <div style="margin-top:10px;font-size:12px;font-weight:bold;">Grow Fast</div>
            <div style="margin-top:10px;font-size:13px;font-weight:bold;color:#ffe600;text-shadow:0 0 6px #000;">LeadSource USA</div>
          </div>
          <div style="position:absolute;bottom:12px;left:10px;right:10px;background:#00ff66;color:#000;font-size:13px;font-weight:bold;padding:8px 0;border-radius:6px;text-align:center;box-shadow:0 0 15px rgba(0,255,100,0.9);animation:adPulse2 1.3s infinite;">GET LEADS</div>
        </div>
      </a>
    </div>
    <div class="ad-slot">
      <div class="ad-label">Advertisement</div>
      <div style="height:120px; display:flex; align-items:center; justify-content:center;">
        <div class="ad-placeholder">160 √ó 120<br>Ad Space</div>
      </div>
    </div>
  </div>
</div>

<!-- Tooltip -->
<div id="tooltip">
  <div class="tt-state"></div>
  <div class="tt-leads"></div>
  <div class="tt-sub">registered businesses</div>
  <div class="tt-hot-warm"></div>
  <div class="tt-status"></div>
  <div class="tt-click">Click to view details ‚Üí</div>
</div>

<footer style="text-align:center; padding:16px 32px; border-top:1px solid var(--border); background:rgba(10,12,16,0.96); color:var(--muted); font-size:0.75rem; letter-spacing:1px;">
  ¬© 2026 LeadSource USA. All rights reserved.
</footer>


<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/topojson-client@3"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE DATA & MAPPINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STATE_NAMES = {
  'AL':'Alabama','AK':'Alaska','AZ':'Arizona','AR':'Arkansas','CA':'California','CO':'Colorado',
  'CT':'Connecticut','DE':'Delaware','FL':'Florida','GA':'Georgia','HI':'Hawaii','ID':'Idaho',
  'IL':'Illinois','IN':'Indiana','IA':'Iowa','KS':'Kansas','KY':'Kentucky','LA':'Louisiana',
  'ME':'Maine','MD':'Maryland','MA':'Massachusetts','MI':'Michigan','MN':'Minnesota','MS':'Mississippi',
  'MO':'Missouri','MT':'Montana','NE':'Nebraska','NV':'Nevada','NH':'New Hampshire','NJ':'New Jersey',
  'NM':'New Mexico','NY':'New York','NC':'North Carolina','ND':'North Dakota','OH':'Ohio','OK':'Oklahoma',
  'OR':'Oregon','PA':'Pennsylvania','RI':'Rhode Island','SC':'South Carolina','SD':'South Dakota',
  'TN':'Tennessee','TX':'Texas','UT':'Utah','VT':'Vermont','VA':'Virginia','WA':'Washington',
  'WV':'West Virginia','WI':'Wisconsin','WY':'Wyoming'
};

const FIPS_TO_ABBR = {
  '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE','12':'FL','13':'GA',
  '15':'HI','16':'ID','17':'IL','18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD',
  '25':'MA','26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ',
  '35':'NM','36':'NY','37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC',
  '46':'SD','47':'TN','48':'TX','49':'UT','50':'VT','51':'VA','53':'WA','54':'WV','55':'WI','56':'WY'
};

let stateData = {};      // { 'FL': { leads: 123 }, ... }
let mapBuilt = false;
let lastScrapeTime = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOAD BUSINESS DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadBusinessData() {
  try {
    const response = await fetch('data/businesses.json');
    const data = await response.json();
    
    // Count businesses by state
    const stateCounts = {};
    const todayCounts = {};
    const todayStr = new Date().toDateString();
    data.forEach(biz => {
      const state = biz.state || biz.State || '';
      if (state) {
        stateCounts[state] = (stateCounts[state] || 0) + 1;
        // Count if added today
        const addedDate = biz.scraped_at || biz.created_at || biz.date || '';
        if (addedDate && new Date(addedDate).toDateString() === todayStr) {
          todayCounts[state] = (todayCounts[state] || 0) + 1;
        }
      }
      // Track most recent scrape time
      if (biz.scraped_at) {
        const scrapeTime = new Date(biz.scraped_at).getTime();
        if (!lastScrapeTime || scrapeTime > lastScrapeTime) {
          lastScrapeTime = scrapeTime;
        }
      }
    });

    // Convert to stateData format
    Object.keys(stateCounts).forEach(state => {
      stateData[state] = { leads: stateCounts[state], newToday: todayCounts[state] || 0 };
    });

    updateStats();
    updateSidePanels();
    applyHeatMap();
    
    const lastUpdate = lastScrapeTime ? new Date(lastScrapeTime).toLocaleString() : new Date().toLocaleString();
    document.getElementById('last-update').textContent = lastUpdate;

  } catch (error) {
    console.error('Error loading business data:', error);
    document.getElementById('last-update').textContent = 'Error loading data';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HEAT MAP TIER LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTier(leads) {
  return leads >= 1 ? 'active' : '0';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD D3 MAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function buildMap() {
  const width = 880;
  const height = 550;

  const svg = d3.select('#usmap')
    .attr('viewBox', `0 0 ${width} ${height}`)
    .attr('preserveAspectRatio', 'xMidYMid meet');

  const projection = d3.geoAlbersUsa().scale(1100).translate([width/2, height/2]);
  const path = d3.geoPath().projection(projection);

  const us = await d3.json('https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json');
  const states = topojson.feature(us, us.objects.states);

  const tiny = ['RI','DE','CT','NJ','NH','VT','MA','MD','DC'];

  svg.selectAll('.state-path')
    .data(states.features)
    .enter()
    .append('path')
    .attr('class', d => {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
      const leads = (stateData[abbr] || {}).leads || 0;
      return `state-path tier-${getTier(leads)}`;
    })
    .attr('d', path)
    .attr('data-state', d => FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '')
    .on('mouseenter', function(event, d) {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
      const data = stateData[abbr] || { leads: 0 };
      
      const tip = document.getElementById('tooltip');
      tip.querySelector('.tt-state').textContent = STATE_NAMES[abbr] || abbr;
      tip.querySelector('.tt-leads').textContent = data.leads || 0;
      tip.querySelector('.tt-hot-warm').textContent = 'Business registration opportunities';
      
      const statusEl = tip.querySelector('.tt-status');
      if (data.leads > 0) {
        statusEl.textContent = '‚úÖ DATA AVAILABLE';
        statusEl.className = 'tt-status active';
      } else {
        statusEl.textContent = 'Coming Soon';
        statusEl.className = 'tt-status coming';
      }
      
      tip.classList.add('visible');
      moveTooltip(event);
    })
    .on('mousemove', moveTooltip)
    .on('mouseleave', () => {
      document.getElementById('tooltip').classList.remove('visible');
    })
    .on('click', function(event, d) {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')];
      handleStateClick(abbr);
    });

  svg.selectAll('.state-label')
    .data(states.features)
    .enter()
    .append('text')
    .attr('class', 'state-label')
    .attr('text-anchor', 'middle')
    .attr('dominant-baseline', 'middle')
    .attr('transform', d => { const c = path.centroid(d); return `translate(${c[0]},${c[1]})`; })
    .attr('font-size', d => {
      const abbr = FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '';
      return tiny.includes(abbr) ? '5' : '8';
    })
    .text(d => FIPS_TO_ABBR[String(d.id).padStart(2,'0')] || '');

  document.querySelector('.loading-map').style.display = 'none';
  document.getElementById('usmap').style.display = 'block';

  mapBuilt = true;
  applyHeatMap();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APPLY HEAT COLORS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function applyHeatMap() {
  if (!mapBuilt) return;
  d3.selectAll('.state-path').each(function() {
    const abbr  = this.getAttribute('data-state');
    const leads = (stateData[abbr] || {}).leads || 0;
    this.className.baseVal = `state-path tier-${getTier(leads)}`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATS + PANELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateStats() {
  let totalLeads = 0, activeStates = 0, newToday = 0;

  Object.values(stateData).forEach(d => {
    if (d.leads > 0) { totalLeads += d.leads; activeStates++; }
    if (d.newToday > 0) { newToday += d.newToday; }
  });

  document.getElementById('stat-total-leads').textContent = totalLeads > 0 ? totalLeads.toLocaleString() : '‚Äî';
  document.getElementById('stat-active-states').textContent = activeStates || '‚Äî';
  document.getElementById('stat-new-today').textContent = newToday > 0 ? newToday.toLocaleString() : '0';
}

function updateSidePanels() {
  const sorted = Object.entries(stateData)
    .filter(([,d]) => d.leads > 0)
    .sort((a,b) => b[1].leads - a[1].leads)
    .slice(0, 5);
  const topTotal = sorted.reduce((sum,[,d]) => sum + d.leads, 0);
  document.getElementById('top-states-total').textContent = topTotal.toLocaleString() + ' total leads';

  const items = sorted.map(([abbr,d], i) => `
    <div class="top-state-item" onclick="handleStateClick('${abbr}')">
      <div class="top-state-rank">${i+1}</div>
      <div class="top-state-name">${STATE_NAMES[abbr] || abbr}</div>
      <div class="top-state-leads">${d.leads}</div>
    </div>`);

  document.getElementById('top-states-list').innerHTML =
    items.join('<div class="top-state-divider"></div>');
}

function timeAgo(date) {
  const seconds = Math.floor((Date.now() - date) / 1000);
  if (seconds < 60)  return 'just now';
  if (seconds < 3600)  return Math.floor(seconds/60) + 'm ago';
  if (seconds < 86400) return Math.floor(seconds/3600) + 'h ago';
  return Math.floor(seconds/86400) + 'd ago';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOOLTIP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function moveTooltip(event) {
  const tip = document.getElementById('tooltip');
  tip.style.left = event.clientX + 'px';
  tip.style.top  = event.clientY + 'px';
  tip.style.transform = 'translate(-50%, calc(-100% - 16px))';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLICK HANDLER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleStateClick(abbr) {
  const data = stateData[abbr] || { leads: 0 };
  if (data.leads > 0) {
    window.location.href = `state.html?state=${abbr}`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  await Promise.allSettled([
    buildMap().catch(err => {
      document.getElementById('map-container').innerHTML = `
        <div style="text-align:center;padding:60px;color:var(--muted);">
          <div style="font-size:2rem;margin-bottom:16px;">üó∫Ô∏è</div>
          <p>Map requires an internet connection to load geographic data.</p>
          <p style="margin-top:8px;font-size:0.8rem;">Open this page in a browser with internet access.</p>
        </div>`;
    }),
    loadBusinessData()
  ]);
}

init();
</script>
</body>
</html>
